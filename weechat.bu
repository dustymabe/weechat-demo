variant: fcos
version: 1.3.0
passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDOLFvRYlf2UTC7lZjWO70hKGqtq6Bu+DruqJsXHE/E+v9ziTWebuEcSOZmGNRTNm7CqDoqTJgH5uPrqHfokA+kmMojefqJ9Ha9KY5l8ea9Hk88S9P4ryAW01zFkRY55xBwyIzKL9wReEFvCYTTIHOiRZbDq8PstrPwh8sXBOJhdHzLvjbuDAz7fdgH7/JBsf/FPKJ61aQkjs2a9Xfx5yC9J8wbbvLHU9myxfKPgxMLbWEnAEbFJfUGY849ZO4AiFZHYnQgQaMS1WFpEXBsA8VsFI6pzGAxCs0+7Eyy5fvUTznXdaTpr+vmMxCBllm3M3qGDVZCH04oiEKKUC+2BVQr dustymabe@media
storage:
  directories:
    - path: /home/core/.config
      user:
        name: core
      group:
        name: core
    - path: /home/core/.config/systemd
      user:
        name: core
      group:
        name: core
    - path: /home/core/.config/systemd/user
      user:
        name: core
      group:
        name: core
    - path: /home/core/.config/systemd/user/default.target.wants
      user:
        name: core
      group:
        name: core
  files:
    - path: /var/lib/systemd/linger/core
      mode: 0644
    - path: /usr/local/bin/weechat
      mode: 0755
      contents:
        inline: |
          #!/bin/bash
          # run with bash -l so we can load the environment appropriately
          # so that emojis work
          exec podman exec -it weechat bash -l -c "tmux -2 attach -d"
    - path: /home/core/.config/systemd/user/container-weechat.service
      mode: 0644
      user:
        name: core
      group:
        name: core
      contents:
        inline: |
          # Generated with: podman generate systemd --new --name weechat
          # autogenerated by Podman 3.1.1
          [Unit]
          Description=Podman container-weechat.service
          Documentation=man:podman-generate-systemd(1)
          Wants=network.target
          After=network-online.target
          RequiresMountsFor=/var/home/core/.local/share/containers/storage /run/user/1000/containers
          After=build-weechat.service
          [Service]
          Environment=PODMAN_SYSTEMD_UNIT=%n
          Restart=on-failure
          TimeoutStopSec=70
          ExecStartPre=mkdir -p /home/core/weechat/logs
          ExecStartPre=/bin/rm -f %t/container-weechat.pid %t/container-weechat.ctr-id
          ExecStart=/usr/bin/podman run --conmon-pidfile %t/container-weechat.pid --cidfile %t/container-weechat.ctr-id --cgroups=no-conmon -d --name weechat --replace=true --volume /home/core/weechat/logs/:/weechat/logs/:z localhost/weechat:latest
          ExecStop=/usr/bin/podman stop --ignore --cidfile %t/container-weechat.ctr-id -t 10
          ExecStopPost=/usr/bin/podman rm --ignore -f --cidfile %t/container-weechat.ctr-id
          PIDFile=%t/container-weechat.pid
          Type=forking
          [Install]
          WantedBy=default.target
    - path: /home/core/.config/systemd/user/build-weechat.service
      mode: 0644
      user:
        name: core
      group:
        name: core
      contents:
        inline: |
          [Unit]
          Description=Build weechat container
          # https://github.com/systemd/systemd/issues/3312#issuecomment-893009485
          #After=network-online.target
          #Wants=network-online.target
          [Service]
          # Give time for the build to complete
          TimeoutStartSec=10m
          Type=oneshot
          RemainAfterExit=yes
          # sleep for network
          ExecStartPre=sleep 10
          ExecStartPre=-podman pull registry.fedoraproject.org/fedora:34
          ExecStart=-podman build -t localhost/weechat:latest git://github.com/dustymabe/weechat-demo#main
          ExecStartPost=-podman image prune --force
    - path: /home/core/.config/systemd/user/build-weechat-firstboot.service
      mode: 0644
      user:
        name: core
      group:
        name: core
      contents:
        inline: |
            [Unit]
            Description=Build weechat on first boot
            After=network-online.target
            Wants=network-online.target
            ConditionFirstBoot=yes
            Requires=build-weechat.service
            [Service]
            ExecStart=echo 'requiring weechat be built on first boot'
            [Install]
            WantedBy=default.target
  links:
    - path: /home/core/.config/systemd/user/default.target.wants/container-weechat.service
      user:
        name: core
      group:
        name: core
      target: /home/core/.config/systemd/user/container-weechat.service
    - path: /home/core/.config/systemd/user/default.target.wants/build-weechat-firstboot.service
      user:
        name: core
      group:
        name: core
      target: /home/core/.config/systemd/user/build-weechat-firstboot.service
